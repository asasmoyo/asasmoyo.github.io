<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>No for Each Item in Array in Terraform | relax, you're probably doing fine</title><link href=https://asasmoyo.github.io/index.xml rel=alternate type=application/rss+xml title="relax, you're probably doing fine"><link rel=stylesheet href=/css/style.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://asasmoyo.github.io/blog/no-for-each-item-in-array-in-terraform/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://asasmoyo.github.io><h1 id=nav-heading class="title is-4">relax, you're probably doing fine</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=email href=mailto:arba.sasmoyo@gmail.com target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></i></span></a><a class=level-item aria-label=github href=https://github.com/asasmoyo target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/asasmoyo target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922h-4.388022v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"></div><h2 class="subtitle is-6">March 28, 2020</h2><h1 class=title>No for Each Item in Array in Terraform</h1><div class=content><p>I was importing my team&rsquo;s PagerDuty setup into Terraform today. There are 6 people in PagerDuty users so I thought, I would create locals block with users as array of map containing each name and email. Then I&rsquo;d feed <code>local.users</code> into <code>pagerduty_user</code> resource using <code>for_each</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>locals</span> {
    users <span style=color:#f92672>=</span> [
        {
            name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;John Doe&#34;</span>
            email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;john@company.com&#34;</span>
        },
        {
            name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Somebody&#34;</span>
            email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;somebody@company.com&#34;</span>
        },
        <span style=color:#960050;background-color:#1e0010>//</span> ...
    ]
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;pagerduty_user&#34; &#34;users&#34;</span> {
    for_each <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>users</span>

    name <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span>.<span style=color:#66d9ef>name</span>
    email <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span>.<span style=color:#66d9ef>email</span>
}
</code></pre></div><p>It turned out, <code>for_each</code> doesn&rsquo;t accept array, it only accepts map or set. So above code didn&rsquo;t work but it has to be like bellow:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>locals</span> {
    users <span style=color:#f92672>=</span> [
        john <span style=color:#f92672>=</span> {
            name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;John Doe&#34;</span>
            email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;john@company.com&#34;</span>
        },
        somebody <span style=color:#f92672>=</span> {
            name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Somebody&#34;</span>
            email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;somebody@company.com&#34;</span>
        },
        <span style=color:#960050;background-color:#1e0010>//</span> ...
    ]
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;pagerduty_user&#34; &#34;users&#34;</span> {
    for_each <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>users</span>

    name <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span>.<span style=color:#66d9ef>name</span>
    email <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span>.<span style=color:#66d9ef>email</span>
}
</code></pre></div><p>But why wouldn&rsquo;t it accept array? If I think about it again, it&rsquo;s for a good reason. Let me explain.</p><p>Suppose <code>for_each</code> works with array, what would happen if at some point in the future, you remove one item in the middle of the array? Your resources from that removed index until the end will be shifted forward and neds to be recreated by Terraform. Don&rsquo;t forget that Terraform use index for array resources. So for <code>pagerduty_user</code> resource, there will be <code>pagerduty_user[0]</code>, <code>pagerduty_user[1]</code>, <code>pagerduty_user[2]</code> and soon.</p><p>It may be fine for resources like <code>pagerduty_user</code>, but what would happen if you used on machines with your database in it? And with no backup configured. Yes that could be disaster.</p><div class=related></div></div></div></section><section class=section><div class=container><aside><div id=disqus_thread></div></aside><div id=show_comments><a id=load_comments class="button is-link">Load comments</a></div><script type=text/javascript>var disqus_shortname='asasmoyo-github-io';function disqus(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var hash=window.location.hash.substr(1);if((hash.length>8)&&(hash.substring(0,8)==="comment-")){disqus();document.getElementById("show_comments").style.display="none";}else{document.getElementById('load_comments').onclick=function(){disqus();document.getElementById("show_comments").style.display="none";};}</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p></p></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-109033209-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>